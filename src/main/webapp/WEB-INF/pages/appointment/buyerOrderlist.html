<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>我买的</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <style type="text/css">
        .infinite-scroll-preloader {
            margin-top:-20px;
        }
	 	body{font-family: Arial, Helvetica, sans-serif;}
        /*==样式重写==*/
            /*-导航-*/
        .content{font-family: SimHei;}
        .bar{height: 1.9rem;}
        .title{font-size: .8rem;line-height: 1.9rem;font-family: 'HiraginoSansGB W3';font-weight: 700;color: #000;}
        .bar .icon{padding: .35rem .1rem;font-size: .9rem;}
        .bar-nav~.content{top: 1.9rem;}
        #headbackImg{object-fit: cover;vertical-align: top;}
        .commentAvatarDiv{margin:0 auto;margin-top: 1.625rem;}
        .nickNameSp-box span{display: inline-block;padding: 0 1.15rem;margin-top: .35rem;border-radius: .7rem;font-family: SimHei;font-size: .65rem;line-height: 1.4rem;color: #2d2d2d;background-color: #f8fcfe;box-shadow: 0 1px 5px rgba(0,0,0,.3);}
         /*==新的样式==*/
        /*-两按钮新样式-*/
        .tab-link.button{padding: 1px;background-clip: content-box;}
        .tab-link.jz-btn1{padding-right: 0;border-right-color: transparent;}
        .tab-link.jz-btn2{padding-left: 0;border-left-color: transparent;}
        /*-面板-*/
        .card{margin-left: 0;margin-right: 0;font-family: SimHei;color: #1b1b1b;}
        .list-block.media-list .item-title-row{border-bottom: 1px solid #e7e7e7;padding-left: 1.3rem;}
        .list-block.media-list .item-title{font-size: .8rem;line-height: 1rem;padding-top: .3rem;padding-bottom: .5rem;}
        .list-block .jz-title1{position: relative;font-size: .7rem;line-height: .9rem;padding: .65rem 0 .7rem 1.3rem;}
        .list-block .jz-title1:after{content: '';position: absolute;left:1.3rem;right: 0;bottom: 0;height: 1px;background-color: #e7e7e7;}
        .list-block .jz-title2{padding: .5rem 0 .05rem 1.3rem;}
        .list-block .jz-title2 .jz-id-number{font-size: .7rem;color: #828282;}
        .jz-orange1{color: #fc7f3b;}
        .jz-orange2{color: #ffb359;}
        /*--添加log--*/
        .list-block.media-list .item-title-row,
        .list-block .jz-title1,
        .list-block .jz-title2{
            background-clip: border-box;
            background-repeat: no-repeat;
        }
        .list-block.media-list .item-title-row{
            background-size: .95rem 1rem;
            background-position: left top;
            background-position: left top .3rem;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAoCAYAAACSN4jeAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVRYw+3YMU/VUBiH8d+twFKMKAsJE4txMESdXHDQxUHsqCOzMx+A3UWDOpjoSOJ4oguDkjg5CpNx8ROoEDmJ4WJwoJF677kY4r1tB56kaXp62v+Tt+2bth3HEeJFPMRtw2Udy4r886AJWUJmolyPYQV3MTHkZRErZcZRZoWxitA8bmAPz5FjdsiVqjJbZuxgqZR7r8i3jioW4lJZ3lXcB0W+g40Rim2UGcrMVayXLjpCXMBbjJeT3ijyxREK9RPia9wpt7q4lWG5IgUzQpyuUWoaM5WRcSxnWOiZehmPhXi1JrVHZWaVhY4Qu6oPwRFfsIszIxL6hUnMJfbtj+FgwIFzmuMg+/9zjIbWiqXurW1Ffr5WixC/Y6o6lKrYu1qlBmSmxKb+fZ6h05eZErvSgFhfZkeIe/7u/G2g29qnsrViqXaxo8inarUIcRvnqkOpin2oVWpAZmsvZUrsegMefZmn7eKktFYs1S6+KfL63vkhxK+4UB1KVexjrVIDMlNi2w2I9WWmxG42INaXedouTkprxVLtYleRn63VIsQfDj9+/9Dqt4teuZ8NiPVmZpnD3z5VrjUg1pvZ7QhxE/MNyBzHZoYnTVskeJphDS+aNqnwEmsdEOIk7uEBLkm3kVGyj094hleKfPc3DXZyPp1rq4QAAAAASUVORK5CYII=);}
        .list-block .jz-title1{
            background-size: .975rem;
            background-position: left top;
            background-position: left top .6rem;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAnCAYAAACMo1E1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsSAAALEgHS3X78AAADEUlEQVRYw+2YT0gVQRzHP6svTaegyAwyJKQyiOqmJw/V0cPQyYroD50i6BIUJhgEFRRUh0C7RAadosN08VoQCAVBheRFpcwO0h/K5mn+ea/Dzr63b96+dZ9v3Tr4hWV+M9/fb/bLzsxvZtZB6Q7gBrAPWEMh5oEJQAH9SPGJBOGg9CSwNYLvGNCJFCNJiasCfkX0bQEeJiXME3cKeAGkcYfR/2Qt/3aUbkpKnAOA0o1AoxHrxz2gw2rbjxTvkhCXAkCKKWCqiFX6R0BM1nApoHYFNGWRIp0XVxrVIdwh4KqxawL4Od8HsEdkAciY9lRRnNIDQN9S4sKwGWgz9gyF89MB6oztzV8/6n122uJqTL+pSsRlfPYJQPvqAnhi7DvAcyv2FrAHeA1csbhO4BxwsxJxfjxFivyXU9rxcUNIMVjgrfQlY30J4LYYq7aKeLAupL42wN97b9CczvnH9eXqUHquoJ5HLUrbq7o6VxZzuS00LnF3ya9OKFy9Z4ADlv8OU+4F7ltca9zijoZwHRQncg/bgJOlAuMSd5bClFAP9Bm7Hxiy/HuAXcBb4LbFHfQExyNOiv6iNqU9cYNI8cziThtx40jxyOLwxMWzWpVeH1IXAREpq/Qjl6DjSiWZkHomwD8bpa+45txFlJ711f257TBKt1j+zabcidLdFtcehzh/fuoN8esyTxBagesluIFKxL0CLlcQH4YxYHD54qQYBoZXSBwQ34L4J+KcgLafSYlbalgXA9qOo/Tn/0HcZEDbtSSEwdLD+jgpIeWLk+Il7jF6NlJvMcOJ5KV0G24ibSX4prWKVURFtDnnwb22NZu4BWAUKcpLyko3ANtxF+Mi7oHz+/LFKV2Fu2rPU/iDcRroQYoHEfpwgAtAN4UnmhmgFyn67JCo4nYDH0qwaWADUswv0UcTUGpnWQQ22aMQdeNvDOHqCT6K22gI4aqBjXZjVHFxnF7Km99lvHSc4LsAwFfgd4Q+JoA/JbhpAv4PRhMnxUfc69oo7lbmPW+AI0ixEKGPb8AxYMTq4z3Q5f0w9OMvCoy5yqYWuGgAAAAASUVORK5CYII=);}
        .list-block .jz-title2{
            background-size: 1.025rem;
            background-position: left top;
            background-position: left top .55rem;
            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACkAAAApCAYAAACoYAD2AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsSAAALEgHS3X78AAAD1klEQVRYw82ZT2gUVxzHP/uM0WRMikHRlOIfMCpG9GLVxDRC9dCT01Obi5BGBRUK0mLryYMeLIh6U/wboYsG6cHBk6ChirFSWwqSteou1KhEZattNs6uOuuMh7eTWVd33u66M/F72WXfvDefnd+8378XoVIZZjOwBugAFgItgAZ8BIwAJhAHbgFXgIvo2sNKbhUpE2wi0AX0AJ2AKGO2DVwGTgB96JpVXUjDjADdwE5gTiVPo0B3gd1AL7rmvD+kYbYAJ4H2KsAV6irQja7F/S7yN5dhfg38ERAguXX/xDC7KoM0zG3AaaAxIEBXDcApDPO78iDlhAOUu7EqVwTYh2F+X2ywEPAroC9EwHw5QBe6dqY4pGHOR76DDeMA6GoU+BRdu+3+4JlbupnecQYkd//eHA8ANXmD3fjs4sGOyQAkUjZf3nhZ9A5nl9Qyr9H774mUzajlMGo59P9r88v/dimgbcA3SMefM7eMJHfwcdTOunoAYk9tFl95XnT1wY7JtDYVdxrJjMP+2Et+Gn6lAh0CWtA1y12ti+pEkjcUjVtE4xaxpzbprAws0+si7Fk2iT2za1TTZ+e4xszdU21AgPV/u+FZfh6cV8OWRbUA7Fhay920w+Gk7xPtAX4WGObHyGQhcG1NZDl003ufv10wUTWlE8NsFsDnlJfNvDdoMiNN39okWK35umMBrBHAqrAAXZ1/kB37/sW0CarLOwWwKGzI2Ijnhj6pVwa2xQKYGzbkf3npbrMacpZApvuh6lbae5Iz65TboVEQfCr2li6ZymQ8Xw0CSIUNqdjRhRoVyMouVC2s90z8KKOM5SkB/BM25NQ8H/4wrTT9PQHcDBtyZZ5vzHdHRTQogIGwIdtnSMh01iklG7osgH5k2h6Kzi6pZXqd3Di/PVYCOkC/QNeGkfVvoFqtRbi2YhL6HJl4JTMOm28omxhX0bVhN1U7QgAx3M3m5zZGqK/x3E4y47D1+gsSltKAR8HLfk4jM+GqqrVJ0NokxgDTWYdo3KL91+ellBFDwClwk15dszDMXcDxYjOicWmaBwqXce5+lr+evOmsYyM2ibRTan3japfb1PJWk9XZALIIGm9dA9rdZlZh3b0AuM4HW3cDuYGNhOiSCuQAG/MB34aUoGeAH8YJ8sfCFgv49Xtk82gv4fSEHGA7urbvXYP+ALJveBSYEiDgM2ATutZX7IJSO71RYHkAgL8D69G1O34XqUtZ2SpuAzZQPYc/lFuvTQUIlZ8+bAA+K+lPerKRRyXHCOT04d3AzcBaZMx3z3GmIGumFPJdc89xBoALlZ7jvAZ7ni163vJVZQAAAABJRU5ErkJggg==);}
        /*-end-*/
    </style>
    <script src="//g.alicdn.com/sj/lib/zepto/zepto.min.js"></script>

</head>
<body>
<div class="page-group">
    <div id="page-swiper" class="page">
    <header class="bar bar-nav">
        <a class="icon icon-left pull-left back"></a>
        <h1 class="title">我的订单</h1>
    </header>
    <div class="content">
        <div class="content-block">
            <div class="buttons-row" style="margin-top: 1rem">
                <a href="#ongoingTab" class="tab-link active button jz-btn1">进行中</a>
                <a href="#finishTab" class="tab-link button jz-btn2">已完成</a>
            </div>
            <div class="tabs">
                <div id="ongoingTab" class="tab active infinite-scroll">

                    <div class="list-block media-list" style="margin-top:  0px;">


                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                    <div class="no-record" style="display: none;text-align: center">
                        没有更多记录了
                    </div>
                </div>

                <div id="finishTab" class="tab infinite-scroll">

                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                    <div class="no-record" style="display: none;text-align: center">
                        没有更多记录了
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>
</div>


<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>
<script>
    $(document).on("pageInit", function() {
        $.showIndicator();
        //多个标签页下的无限滚动
        var loading = false;
        // 每次加载添加多少条目
        var itemsPerLoad = 10;
        // 最多可加载的条目
        var maxItems = 30;
        var  lastIndex = $('.list-block ul').length;

        function addItems(number, lastIndex,data,tabId) {

            // 生成新条目的HTML
            var html = '';
            var dataLength = 0;
            var orderStatus = "";
            $.each(data, function(i, order){

                if(order.orderStatus == 'BEGIN'){
                    orderStatus = "已经向卖家发出邀请";
                }else if(order.orderStatus == 'SELLER_APPLY'){
                    orderStatus = "卖家已经回复，可以付款了";
                }else if(order.orderStatus == 'BUYER_CONFIRM'){
                    orderStatus = "已付款,等待卖家确认";
                }else if(order.orderStatus == 'SELLER_CONFIRM'){
                    orderStatus = "卖家已经确认，沟通时间是"+order.finalAppointmentTime;
                }else if(order.orderStatus == 'SELLER_FINISH'){
                    orderStatus = "卖家已经确认完成双方邀约";
                }else if(order.orderStatus == 'BUYLLER_FINISH'){
                    orderStatus = "您已经确认完成双方邀约";
                }else if(order.orderStatus == 'NEED_RATED'){
                    orderStatus = "请评价";
                }else if(order.orderStatus == 'FINISH'){
                    orderStatus = "已完成";
                }
                var remindCount = order.remindCount;
                var remindHtml = '';
                if(remindCount > 0){
                    remindHtml = '<span class="badge" style="position: absolute;top: 1rem;right: 1rem;background:red;color: white;">'+remindCount+'</span>';
                }
                html += '<div class="card" >'+
                            '<div class="card-content">'+
                                '<div class="list-block">'+
                                    '<ul onclick="toFixOrder(\''+order.orderId+'\',\''+order.orderStatus+'\')">'+
                                        '<li class="item-content">'+
                                            '<div class="item-inner">'+
                                                '<div class="item-title-row">'+
                                                    '<div class="item-title">'+order.itemTitle+'</div>'+
                                                '</div>'+
                                                '<div class="item-subtitle jz-title1">'+orderStatus+'</div>'+
                                                '<div class="item-subtitle jz-title2">订单ID：<span class="jz-id-number">'+order.orderId+'</span></div>'+
                                                    remindHtml+
                                            '</div>'+
                                        '</li>'+
                                    '</ul>'+
                                '</div>'+
                            '</div>'+
                        '</div>';
                dataLength += 1;
            });
            if(dataLength == 0){
                $('.no-record').show();
                $('.infinite-scroll-preloader').remove();
            }else{
                $('.no-record').hide();
                $('.infinite-scroll-preloader').hide();
                // 添加新条目
                //$('.active.infinite-scroll .list-block').append(html);
                $('#'+tabId+'.infinite-scroll .list-block').append(html);
            }


        }
        $.post('${request.contextPath}/order/my-order-list', {orderStatus:'ongoing',optUserType:'buyer',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            $('#ongoingTab.infinite-scroll .list-block').empty();
            addItems(itemsPerLoad, 0,response,'ongoingTab');
            $.hideIndicator();
        });
        $.post('${request.contextPath}/order/my-order-list', {orderStatus:'FINISH',optUserType:'buyer',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            $('#finishTab.infinite-scroll .list-block').empty();
            addItems(itemsPerLoad, 0,response,'finishTab');
            $.hideIndicator();
        });
        $(document).on('infinite', function() {
            // 如果正在加载，则退出
            var noRecordDisplay = $('.no-record').css('display');

            if (loading) return;
            // 设置flag
            loading = true;
            var tabIndex = 0;
            var dataType = 'ongoing';
            var tabId = $(this).find('.infinite-scroll.active').attr('id');
            if(tabId == "finishTab"){
                tabIndex = 2;
                dataType = 'FINISH';
            }

            lastIndex = $('.list-block').eq(tabIndex).find('ul').length;
            $.post('${request.contextPath}/order/my-order-list', {orderStatus:dataType,optUserType:'buyer',startIndex: lastIndex,loadSize:itemsPerLoad}, function (response) {
                setTimeout(function() {
                    // 重置加载flag
                    loading = false;

                    if (lastIndex >= maxItems) {
                        // 加载完毕，则注销无限加载事件，以防不必要的加载
                        $.detachInfiniteScroll($('.infinite-scroll'));
                        // 删除加载提示符
                        $('.infinite-scroll-preloader').remove();
                        return;
                    }
                    // 添加新条目
                    addItems(itemsPerLoad, lastIndex,response,tabId);
                    // 更新最后加载的序号
                    lastIndex = $('.list-block ul').length;
                    //容器发生改变,如果是js滚动，需要刷新滚动
                    $.refreshScroller();
                }, 1000);
            });
        });
    });
    function toFixOrder(id,orderStatus){
        if(orderStatus == 'SELLER_APPLY'){
            window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxcd8903dd6a9552eb&redirect_uri=http%3A%2F%2Fjk.zhangqidong.cn%2Ftime%2Forder%2Fto-buyer-confirm%2F&response_type=code&scope=snsapi_base&state="+id+"#wechat_redirect";
        }else{
            window.location.href = "${request.contextPath}/order/fix-buyer-order/"+id;
        }

    }
    $("body").on( "click", ".back", function(){
        window.location.href = '${request.contextPath}/user/to-my-page';
    } );
    //以下是处理点击系统后退
    var currentUrl = window.location.href;
    if(currentUrl.indexOf('#') == -1 ){
        //event.state refers to the second last state that was pushed.
        // You need to have pushed state at least twice for e.state to not be null.
        // This is because you should save the state when your site is loaded the first time and thereafter every time it changes state.
        history.pushState({init:true}, "我的信息", window.location.href+"#");
        history.pushState({init:true}, "我的信息", window.location.href+"1");
    }
    window.onpopstate = function(event){
        var stateStr = event.state;
        if(stateStr != null){//==null的时候是像safari这样的浏览器，第一次进入界面的时候就执行onpopstate方法，这时pushState并没有执行，不应该跳转
            window.location.href = '${request.contextPath}/user/to-my-page';
        }
    };
</script>
<script>$.init();</script>
</body>
</html>