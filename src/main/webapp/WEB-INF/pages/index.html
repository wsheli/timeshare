
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>时刻</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-114x114.png">
    <style type="text/css">
        .infinite-scroll-preloader {
            margin-top:-20px;
        }
        .commentAvatarDiv{
            width: 50px;
            height: 50px;
            padding:0px;
            background: #ececec;
            border-radius:50px;
            box-shadow: 0px 0px 0px rgba(0,0,0,0.4);
            -moz-border-radius: 50px;
            -webkit-border-radius: 50px;
        }
        .commentAvatarImage{
            width:50px;
            height:50px;
            line-height: 0;	 /* remove line-height */
            display: inline-block;	/* circle wraps image */
            border-radius: 50%;	/* relative value */
            -moz-border-radius: 50%;
            -webkit-border-radius: 50%;
            transition: linear 0.25s;
        }
    </style>
    <script src="//g.alicdn.com/sj/lib/zepto/zepto.min.js"></script>

</head>
<body>
<div class="page-group" >
    <div id="page-swiper" class="page">

        <nav class="bar bar-tab">
            <a class="tab-item active" href="#">
                <span class="icon icon-cart"></span>
                <span class="tab-label">买时间</span>
            </a>
            <a class="tab-item" id="mySellBtn">
                <span class="icon icon-star"></span>
                <span class="tab-label">卖时间</span>
            </a>
            <a class="tab-item" href="#" id="myPageBtn">
                <span class="icon icon-me"></span>
                <span class="tab-label">我的</span>
            </a>
        </nav>
        <!--<div class="bar">-->
            <!--<div class="searchbar">-->
                <!--<div class="search-input">-->
                    <!--<label class="icon icon-search" for="search"></label>-->
                    <!--<input type="search" id='search' placeholder='输入关键字...'/>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <div class="content" id=''>

            <div class="swiper-container"  style="position: relative;padding-bottom: 0px;">
                <div class="swiper-wrapper">

                </div>
                <div class="swiper-pagination" style="position: absolute;right: 20px;width: 20%;bottom: 20px"></div>
            </div>
            <div class="buttons-tab">
                <a href="#recommendTab" class="tab-link active button">推荐</a>
                <a href="#newTab" class="tab-link button">最新</a>
                <a href="#hotTab" class="tab-link button">最火</a>
                <a href="#goodTab" class="tab-link button">最优</a>
            </div>

                <div class="tabs">
                    <div id="recommendTab" class="tab active infinite-scroll">

                        <div class="list-block media-list" style="margin-top:  0px;">

                        </div>
                        <!-- 加载提示符 -->
                        <div class="infinite-scroll-preloader">
                            <div class="preloader">
                            </div>
                        </div>
                    </div>
                    <div id="newTab" class="tab infinite-scroll">
                        <div class="list-block media-list" style="margin-top:  0px;">

                        </div>
                        <!-- 加载提示符 -->
                        <div class="infinite-scroll-preloader">
                            <div class="preloader">
                            </div>
                        </div>
                    </div>
                    <div id="hotTab" class="tab infinite-scroll">
                        <div class="list-block media-list" style="margin-top:  0px;">

                        </div>
                        <!-- 加载提示符 -->
                        <div class="infinite-scroll-preloader">
                            <div class="preloader">
                            </div>
                        </div>
                    </div>
                    <div id="goodTab" class="tab infinite-scroll">
                        <div class="list-block media-list" style="margin-top:  0px;">

                        </div>
                        <!-- 加载提示符 -->
                        <div class="infinite-scroll-preloader">
                            <div class="preloader">
                            </div>
                        </div>
                    </div>
                </div>


        </div>
    </div>

</div>
<script src="//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js"></script>
<script src="//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js"></script>
<script>
    function toViewUserItem(id){
        window.location.href = "${request.contextPath}/user/to-view-items/"+id;
    }
    $(document).on("pageInit", function() {
        $.showIndicator();

        function addLunboItem(datas){
            var dataLength = 3;
            if(datas.length < 3){
                dataLength = datas.length;
            }
            var headPicArr = [1,2,3,4,5,6];
            for(var i = 0;i < dataLength;i++){
                var n = Math.floor(Math.random() * headPicArr.length + 1)-1;
                var html = '<div class="swiper-slide">'+
                        '<img  src="${request.contextPath}/images/headback'+headPicArr[n]+'.jpg"  style="width: 100%;height: 240px;" onclick="toViewUserItem(\''+datas[i].item.userId+'\')">'+
                        '<div  style="position: absolute;right: 10px;width: 70%;bottom: 20px;z-index: 999;font-weight: bold;color: #ffffff">'+datas[i].item.title+'</div>'+
                        '</div>';
                $('.swiper-wrapper').append(html);
            }

            $(".swiper-container").swiper({
                autoplay: 5000,//可选选项，自动滑动
            });
            //$.reinitSwiper('.swiper-container');
        }
        //多个标签页下的无限滚动
        var loading = false;
        // 每次加载添加多少条目
        var itemsPerLoad = 10;
        // 最多可加载的条目
        var maxItems = 30;
        var  lastIndex = $('.list-block ul').length;
        function addItems(number, lastIndex,data,tabId) {
            // 生成新条目的HTML
            var html = '';
            var dataLength = 0;
            $.each(data, function(i, item){
                var itemStatus = "";
                if(item.item.itemStatus == 'for_sale'){
                    itemStatus = "销售中";
                }else if(item.item.itemStatus == 'undercarriage'){
                    itemStatus = "已下架";
                }else if(item.item.itemStatus == 'draft'){
                    itemStatus = "草稿";
                }
                var headPic = item.headImgPath;
                if(headPic == '' || headPic == null){
                    headPic = '${request.contextPath}/images/default_head.jpg';
                }
                html += '<ul>'+
                            '<li>'+
                                '<a href="#" class="item-link item-content" onclick="toViewUserItem(\''+item.item.userId+'\')">'+
                                    '<div class="item-media">' +
                                        '<div class="commentAvatarDiv">' +
                                            '<img class="commentAvatarImage" src="'+headPic+'" />' +
                                        '</div>' +
                                    '</div>'+
                                    '<div class="item-inner">'+
                                        '<div class="item-title-row">'+
                                            '<div class="item-title">'+item.item.title+'</div>'+
                                        '</div>'+
                                        '<div class="item-subtitle">'+item.item.createUserName+'</div>'+
                                        '<div class="item-text">'+item.item.useCount+'人咨询过</div>'+
                                    '</div>'+
                                '</a>'+
                            '</li>'+
                        '</ul>';
                dataLength += 1;
            });
            if(dataLength == 0){
                $('.no-record').show();
                $('.infinite-scroll-preloader').remove();
            }else{
                $('.no-record').hide();
                $('.infinite-scroll-preloader').hide();
                // 添加新条目
                //$('.active.infinite-scroll .list-block').append(html);
                $('#'+tabId+'.infinite-scroll .list-block').append(html);
            }


        }
        $.post('${request.contextPath}/item/list-by-condition', {condition:'recommend',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            addItems(itemsPerLoad, 0,response,'recommendTab');
            addLunboItem(response);
            $.hideIndicator();
        });
        $.post('${request.contextPath}/item/list-by-condition', {condition:'new',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            addItems(itemsPerLoad, 0,response,'newTab');
        });
        $.post('${request.contextPath}/item/list-by-condition', {condition:'hot',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            addItems(itemsPerLoad, 0,response,'hotTab');
        });
        $.post('${request.contextPath}/item/list-by-condition', {condition:'good',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            addItems(itemsPerLoad, 0,response,'goodTab');
        });
        $(document).on('infinite', function() {
            // 如果正在加载，则退出
            if (loading) return;
            // 设置flag
            loading = true;
            var tabIndex = 0;
            var dataType = 'recommend';
            var tabId = $(this).find('.infinite-scroll.active').attr('id');
            if(tabId == "newTab"){
                tabIndex = 1;
                dataType = 'new';
            }
            if(tabId == "hotTab"){
                tabIndex = 2;
                dataType = 'hot';
            }
            if(tabId == "goodTab"){
                tabIndex = 3;
                dataType = 'good';
            }
            lastIndex = $('.list-block').eq(tabIndex).find('ul').length;
            $.post('${request.contextPath}/item/list-by-condition', {condition:dataType,startIndex: lastIndex,loadSize:itemsPerLoad}, function (response) {
                setTimeout(function() {
                    // 重置加载flag
                    loading = false;

                    if (lastIndex >= maxItems) {
                        // 加载完毕，则注销无限加载事件，以防不必要的加载
                        $.detachInfiniteScroll($('.infinite-scroll'));
                        // 删除加载提示符
                        $('.infinite-scroll-preloader').remove();
                        return;
                    }
                    // 添加新条目
                    addItems(itemsPerLoad, lastIndex,response,tabId);
                    // 更新最后加载的序号
                    lastIndex = $('.list-block ul').length;
                    //容器发生改变,如果是js滚动，需要刷新滚动
                    $.refreshScroller();
                }, 1000);
            });
        });
    });

    $("#myPageBtn").on('click', function () {
        window.location.href = '${request.contextPath}/wx/to-get-open-id';
    });
    $("#mySellBtn").on('click', function () {
        var backUrl = '/item/to-list';
        window.location.href = '${request.contextPath}/wx/to-get-open-id?backUrl='+encodeURIComponent(backUrl);
    });
    $.init();
</script>
</body>
</html>
