<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title><#if (order.orderStatus == 'BUYER_CONFIRM')>您已付款<#else>卖家答复啦</#if></title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <style>
        .payment-item{
            float: left;
            position: relative;
            border: 1px solid #ddd;
            height: 2rem;
            padding: 0.5rem 5px;
            margin-left: 1rem;
            cursor: pointer;
        }
        .payment-item-selected{
            border: 2px solid #e4393c;
        }
    </style>
</head>
<body>

<input type="hidden" id="userId" value="${userId}">
<div class="page-group">
    <div class="page page-current">
        <div class="content">
            <div class="card">
                <div class="card-content">
                    <div class="list-block media-list">
                        <ul>
                            <li class="item-content">
                                <div class="item-media">
                                    <div class="commentAvatarDiv" style="width: 44px;height: 44px">
                                        <img class="commentAvatarImage" src="../images/head.jpg" style="width: 44px;height: 44px"   >
                                    </div>
                                </div>
                                <div class="item-inner">
                                    <div class="item-title-row">
                                        <div class="item-title"><span id="titleSp"></span></div>
                                    </div>
                                    <div class="item-subtitle content-padded">
                                        <div class="row">
                                            <div class="col-33"><span id="createUserNameSp" ></span></div>
                                            <div class="col-33"><span id="priceSp" >${order.price}</span>元/次</div>
                                            <div class="col-33"><span id="dateSp" >${order.optTime}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <form action="${request.contextPath}/order/save" method="post">
                <input type="hidden" id="orderId" name="orderId" value="${order.orderId}">
                <input type="hidden" id="itemId" name="itemId" value="${order.itemId}">
                <input type="hidden" id="orderStatus" name="orderStatus" value="BUYER_CONFIRM">
                <input type="hidden" id="optUserType" name="optUserType" value="buyer">
                <div class="list-block cards-list">
                    <ul>
                        <li class="card">
                            <div class="card-header">您填写的问题</div>
                            <div class="card-content">
                                <div class="card-content-inner" id="orderProblem">
                                    ${order.orderProblem}
                                </div>
                            </div>
                        </li>
                        <li class="card">
                            <div class="card-header">您的自我介绍</div>
                            <div class="card-content">
                                <div class="card-content-inner" id="orderUserDescription">
                                    ${order.orderUserDescription}
                                </div>
                            </div>
                        </li>
                        <li class="card">
                            <div class="card-header">卖家建议的沟通时间</div>
                            <div class="card-content">
                                <div class="card-content-inner">
                                    ${order.suggestAppointmentTime!''}
                                </div>
                            </div>
                        </li>
                        <li class="card">
                            <div class="card-header">卖家填写的联系手机号</div>
                            <div class="card-content">
                                <div class="card-content-inner">
                                    ${order.sellerPhone!''}
                                </div>
                            </div>
                        </li>
                        <li class="card">
                            <div class="card-header"><#if (order.finalAppointmentTime)??>最终沟通时间为<#else>选择具体沟通时间</#if></div>
                            <div class="card-content">
                                <div class="card-content-inner" >
                                    <input type="text" name="finalAppointmentTime" id="finalAppointmentTime" value="${order.finalAppointmentTime!''}">
                                </div>
                            </div>
                        </li>
                        <li class="card" id="payType">
                            <div class="card-header">选择付款方式</div>
                            <div class="card-content">
                                <div class="card-content-inner" style="height: 4rem;">
                                    <div id="div1" class="payment-item">微信支付</div>
                                    <div id="div2" class="payment-item">线下支付</div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </form>

            <div class="content-block">
                <div class="row">
                    <div class="col-50"><a href="#" id="saveOrderBtn" class="button button-big button-fill button-danger">确定</a></div>
                    <div class="col-50"><a href="#" class="button button-big button-fill button-success">取消</a></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>
<script>$.init()</script>
<script>
    var orderStatus = '${order.orderStatus}';
    var payStatus = '${payStatus}';

    if(payStatus == 'ORDERPAID'){
        $('#payType').hide();
        $('#saveOrderBtn').hide();
    }


    function checkForm(){
        var suggestAppointmentTime = $('#suggestAppointmentTime').val();
        var sellerPhone = $('#sellerPhone').val();
        if(suggestAppointmentTime.length == 0){
            $.toast('建议的时间段不能为空');
            return false;
        }

        if(sellerPhone.length < 11 ){
            $.toast('请填写正确的手机号');
            return false;
        }
        return true;
    }
    $("#saveOrderBtn").on('click', function () {

//        var vali = checkForm();
//        if(vali){
//            $.showIndicator();
//            $('form').submit();
//        }
        $.confirm('您需要支付'+${order.price}+'元,确定吗？',
                function () {
                    payIt();
                }
        );

    });

    $(".payment-item").on('click', function () {
        $('.payment-item').removeClass('payment-item-selected');
        $(this).addClass('payment-item-selected');
    });

    function onBridgeReady(){
        WeixinJSBridge.invoke(
                'getBrandWCPayRequest', ${jsApiParams},
                function(res){
                    if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                        $.alert('支付成功，卖家会与您联系', function () {
                            $('form').submit();
                        });
                    }	 // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回	ok，但并不保证它绝对可靠。
                }
        );
    }
    function payIt(){
        if (typeof WeixinJSBridge == "undefined"){
            if( document.addEventListener ){
                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
            }else if (document.attachEvent){
                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
            }
        }else{
            onBridgeReady();
        }
    }

    var finalAppointmentTime = "${order.finalAppointmentTime!''}";
    if(finalAppointmentTime == ''){
        var date = new Date();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        $("#finalAppointmentTime").datetimePicker({

            value: [date.getFullYear(), month, strDate, date.getHours(), '00']
        });
    }


</script>

</body>
</html>