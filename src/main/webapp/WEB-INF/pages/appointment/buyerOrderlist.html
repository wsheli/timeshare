<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>我买的</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style type="text/css">
        .infinite-scroll-preloader {
            margin-top:-20px;
        }

    </style>
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
    <script src="//g.alicdn.com/sj/lib/zepto/zepto.min.js"></script>

</head>
<body>
<div class="page-group">
    <div id="page-swiper" class="page">
    <header class="bar bar-nav">
        <a class="icon icon-left pull-left back"></a>
        <h1 class="title">我的订单</h1>
    </header>
    <div class="content">
        <div class="content-block">
            <div class="buttons-row" style="margin-top: 1rem">
                <a href="#ongoingTab" class="tab-link active button">进行中</a>
                <a href="#finishTab" class="tab-link button">已完成</a>
            </div>
            <div class="tabs">
                <div id="ongoingTab" class="tab active infinite-scroll">

                    <div class="list-block media-list" style="margin-top:  0px;">


                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                    <div class="no-record" style="display: none;text-align: center">
                        没有更多记录了
                    </div>
                </div>

                <div id="finishTab" class="tab infinite-scroll">

                    <div class="list-block media-list" style="margin-top:  0px;">

                    </div>
                    <!-- 加载提示符 -->
                    <div class="infinite-scroll-preloader">
                        <div class="preloader">
                        </div>
                    </div>
                    <div class="no-record" style="display: none;text-align: center">
                        没有更多记录了
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>
</div>


<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>
<script>
    $(document).on("pageInit", function() {
        $.showIndicator();
        //多个标签页下的无限滚动
        var loading = false;
        // 每次加载添加多少条目
        var itemsPerLoad = 10;
        // 最多可加载的条目
        var maxItems = 30;
        var  lastIndex = $('.list-block ul').length;

        function addItems(number, lastIndex,data,tabId) {

            // 生成新条目的HTML
            var html = '';
            var dataLength = 0;
            var orderStatus = "";
            $.each(data, function(i, order){

                if(order.orderStatus == 'BEGIN'){
                    orderStatus = "已经向卖家发出邀请";
                }else if(order.orderStatus == 'SELLER_APPLY'){
                    orderStatus = "卖家已经回复，可以付款了";
                }else if(order.orderStatus == 'BUYER_CONFIRM'){
                    orderStatus = "已付款,等待卖家确认";
                }else if(order.orderStatus == 'SELLER_CONFIRM'){
                    orderStatus = "卖家已经确认，沟通时间是"+order.finalAppointmentTime;
                }else if(order.orderStatus == 'SELLER_FINISH'){
                    orderStatus = "卖家已经确认完成双方邀约";
                }else if(order.orderStatus == 'BUYLLER_FINISH'){
                    orderStatus = "您已经确认完成双方邀约";
                }else if(order.orderStatus == 'NEED_RATED'){
                    orderStatus = "请评价";
                }else if(order.orderStatus == 'FINISH'){
                    orderStatus = "已完成";
                }
                var remindCount = order.remindCount;
                var remindHtml = '';
                if(remindCount > 0){
                    remindHtml = '<span class="badge" style="position: absolute;top: 1rem;right: 1rem;background:red;color: white;">'+remindCount+'</span>';
                }
                html += '<div class="card" >'+
                            '<div class="card-content">'+
                                '<div class="list-block">'+
                                    '<ul onclick="toFixOrder(\''+order.orderId+'\',\''+order.orderStatus+'\')">'+
                                        '<li class="item-content">'+
                                            '<div class="item-inner">'+
                                                '<div class="item-title-row">'+
                                                    '<div class="item-title">'+order.itemTitle+'</div>'+
                                                '</div>'+
                                                '<div class="item-subtitle">'+orderStatus+'</div>'+
                                                '<div class="item-subtitle">订单ID：'+order.orderId+'</div>'+
                                                    remindHtml+
                                            '</div>'+
                                        '</li>'+
                                    '</ul>'+
                                '</div>'+
                            '</div>'+
                        '</div>';
                dataLength += 1;
            });
            if(dataLength == 0){
                $('.no-record').show();
                $('.infinite-scroll-preloader').remove();
            }else{
                $('.no-record').hide();
                $('.infinite-scroll-preloader').hide();
                // 添加新条目
                //$('.active.infinite-scroll .list-block').append(html);
                $('#'+tabId+'.infinite-scroll .list-block').append(html);
            }


        }
        $.post('${request.contextPath}/order/my-order-list', {orderStatus:'ongoing',optUserType:'buyer',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            $('#ongoingTab.infinite-scroll .list-block').empty();
            addItems(itemsPerLoad, 0,response,'ongoingTab');
            $.hideIndicator();
        });
        $.post('${request.contextPath}/order/my-order-list', {orderStatus:'FINISH',optUserType:'buyer',startIndex: 0,loadSize:itemsPerLoad}, function (response) {
            //预先加载20条
            $('#finishTab.infinite-scroll .list-block').empty();
            addItems(itemsPerLoad, 0,response,'finishTab');
            $.hideIndicator();
        });
        $(document).on('infinite', function() {
            // 如果正在加载，则退出
            var noRecordDisplay = $('.no-record').css('display');

            if (loading) return;
            // 设置flag
            loading = true;
            var tabIndex = 0;
            var dataType = 'ongoing';
            var tabId = $(this).find('.infinite-scroll.active').attr('id');
            if(tabId == "finishTab"){
                tabIndex = 2;
                dataType = 'FINISH';
            }

            lastIndex = $('.list-block').eq(tabIndex).find('ul').length;
            $.post('${request.contextPath}/order/my-order-list', {orderStatus:dataType,optUserType:'buyer',startIndex: lastIndex,loadSize:itemsPerLoad}, function (response) {
                setTimeout(function() {
                    // 重置加载flag
                    loading = false;

                    if (lastIndex >= maxItems) {
                        // 加载完毕，则注销无限加载事件，以防不必要的加载
                        $.detachInfiniteScroll($('.infinite-scroll'));
                        // 删除加载提示符
                        $('.infinite-scroll-preloader').remove();
                        return;
                    }
                    // 添加新条目
                    addItems(itemsPerLoad, lastIndex,response,tabId);
                    // 更新最后加载的序号
                    lastIndex = $('.list-block ul').length;
                    //容器发生改变,如果是js滚动，需要刷新滚动
                    $.refreshScroller();
                }, 1000);
            });
        });
    });
    function toFixOrder(id,orderStatus){
        if(orderStatus == 'SELLER_APPLY'){
            window.location.href = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxcd8903dd6a9552eb&redirect_uri=http%3A%2F%2Fjk.zhangqidong.cn%2Ftime%2Forder%2Fto-buyer-confirm%2F&response_type=code&scope=snsapi_base&state="+id+"#wechat_redirect";
        }else{
            window.location.href = "${request.contextPath}/order/fix-buyer-order/"+id;
        }

    }
    $("body").on( "click", ".back", function(){
        window.location.href = '${request.contextPath}/user/to-my-page';
    } );
    //以下是处理点击系统后退
    var currentUrl = window.location.href;
    if(currentUrl.indexOf('#') == -1 ){
        //event.state refers to the second last state that was pushed.
        // You need to have pushed state at least twice for e.state to not be null.
        // This is because you should save the state when your site is loaded the first time and thereafter every time it changes state.
        history.pushState({init:true}, "我的信息", window.location.href+"#");
        history.pushState({init:true}, "我的信息", window.location.href+"1");
    }
    window.onpopstate = function(event){
        var stateStr = event.state;
        if(stateStr != null){//==null的时候是像safari这样的浏览器，第一次进入界面的时候就执行onpopstate方法，这时pushState并没有执行，不应该跳转
            window.location.href = '${request.contextPath}/user/to-my-page';
        }
    };
</script>
<script>$.init();</script>
</body>
</html>